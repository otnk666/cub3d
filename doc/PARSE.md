# cub3D パース仕様書

## 基本要件

- **プログラム名**: `cub3D`
- **引数**: `.cub`拡張子のマップファイル
- **実行例**: `./cub3D map.cub`

---

## .cubファイルの構造

### 1. テクスチャパス (4種類)

```
NO ./path_to_north_texture
SO ./path_to_south_texture  
WE ./path_to_west_texture
EA ./path_to_east_texture
```

- 識別子(NO/SO/WE/EA) + スペース + ファイルパス
- 各方向の壁のテクスチャを指定

### 2. 色情報 (2種類)

```
F 220,100,0
C 225,30,0
```

- **F**: 床の色(Floor)
- **C**: 天井の色(Ceiling)
- RGB形式、各値は0-255の範囲
- カンマ区切り、スペースなし

### 3. マップ (必ず最後)

```
1111111111
1000000001
100N000001
1000000001
1111111111
```

#### 使用可能文字

- `0`: 空間
- `1`: 壁
- `N/S/E/W`: プレイヤーの初期位置と向き
- スペース: 有効な空間(パース必要)

#### マップルール

- 壁(1)で完全に囲まれている必要がある
- プレイヤー位置は1つだけ
- 不規則な形状も可能(スペースを含む)
- マップは必ずファイルの最後に配置

---

## パース処理の流れ

### 1. 引数チェック

```c
// チェック項目:
// - 引数が1つか
// - .cub拡張子か
// - ファイルが開けるか
```

### 2. ファイル読み込み

```c
// 処理順序:
// 1. ファイルを開く
// 2. 1行ずつ読み込み
// 3. 各要素を識別・パース
// 4. マップは最後にまとめて処理
```

### 3. 要素の識別

```c
// 識別子で判定:
// - "NO" → 北テクスチャ
// - "SO" → 南テクスチャ  
// - "WE" → 西テクスチャ
// - "EA" → 東テクスチャ
// - "F"  → 床色
// - "C"  → 天井色
// - "1"/"0"/プレイヤー文字 → マップ開始
```

### 4. エラーチェック

**必須エラー検出:**

- テクスチャファイルが存在しない
- 色の値が範囲外(0-255)
- マップが壁で囲まれていない
- プレイヤー位置が0個または2個以上
- 無効な文字が含まれる
- 重複する要素定義
- マップがファイルの最後でない
- 要素とマップの間に空行があってもOK

---

## データ構造 (例)

```c
typedef struct s_map {
    char    **grid;          // マップの2D配列
    int     width;
    int     height;
} t_map;

typedef struct s_textures {
    char    *north;
    char    *south;
    char    *west;
    char    *east;
} t_textures;

typedef struct s_colors {
    int     floor_r;
    int     floor_g;
    int     floor_b;
    int     ceiling_r;
    int     ceiling_g;
    int     ceiling_b;
} t_colors;

typedef struct s_player {
    double  x;
    double  y;
    char    direction;  // N/S/E/W
} t_player;

typedef struct s_game {
    t_map       map;
    t_textures  textures;
    t_colors    colors;
    t_player    player;
} t_game;
```

---

## エラー出力

```c
// エラー時は必ず:
printf("Error\n");
printf("具体的なエラーメッセージ\n");
exit(1);
```

---

## 実装のポイント

### パース優先順位

1. **引数チェック** - 最初に実行
2. **ファイルオープン** - 失敗時は即エラー
3. **テクスチャ・色情報パース** - 順不同でOK
4. **マップパース** - 必ず最後
5. **総合バリデーション** - 全要素が揃っているか確認

### 注意点

- 要素間の空行は許可される
- 各行の空白・タブは無視
- マップ内のスペースは有効な文字として扱う
- マップの各行の長さは異なっても良い(不規則形状対応)

---

## サンプル .cub ファイル

```
NO ./textures/north.xpm
SO ./textures/south.xpm
WE ./textures/west.xpm
EA ./textures/east.xpm

F 220,100,0
C 225,30,0

1111111111111111111111111
1000000000110000000000001
1011000001110000000000001
1001000000000000000000001
111111111011000001110000000000001
100000000011000001110111111111111
11110111111111011100000010001
11110111111111011101010010001
11000000110101011100000010001
10000000000000001100000010001
10000000000000001101010010001
11000001110101011111011110N0111
11110111 1110101 101111010001
11111111 1111111 111111111111
```

---

## テスト項目

### 正常系

- [ ] 正しい.cubファイルが読み込める
- [ ] テクスチャパスが正しく取得できる
- [ ] 色情報(RGB)が正しくパースされる
- [ ] マップが正しく2D配列に格納される
- [ ] プレイヤー位置が正しく検出される

### 異常系

- [ ] 引数なし/引数過多でエラー
- [ ] 拡張子が.cub以外でエラー
- [ ] ファイルが存在しない
- [ ] テクスチャファイルが存在しない
- [ ] 色の値が範囲外
- [ ] マップが壁で囲まれていない
- [ ] プレイヤーが0個または2個以上
- [ ] 無効な文字が含まれる
- [ ] 重複する要素定義

---

## 実装順序の提案

1. 引数チェック関数
2. ファイルオープン関数
3. 行読み込みループ
4. 識別子判定関数
5. テクスチャパース関数
6. 色パース関数
7. マップパース関数
8. マップバリデーション関数
9. エラーハンドリング
10. メモリ解放関数
